from datetime import datetime
from pathlib import Path
from PIL.Image import Image as IMG
from pil_utils import BuildImage
from meme_generator import add_meme
from meme_generator.utils import save_gif

img_dir = Path(__file__).parent / "images"

def tuhalang(images: list[BuildImage], texts, args):
    # 处理用户头像：转换为圆形透明PNG
    avatar = images[0].convert("RGBA")
    avatar = avatar.resize((60, 60)).circle()  # 调整基础尺寸
    
    frames: list[IMG] = []
    
    # 位置参数列表 (x, y, width, height) - 共84个位置数据
    locs = [
        (54, 26, 50, 42),
        (53, 27, 50, 42),
        (53, 27, 50, 42),
        (53, 26, 50, 42),
        (53, 27, 50, 42),
        (54, 26, 50, 42),
        (52, 28, 50, 42),
        (52, 28, 46, 39),
        (54, 29, 46, 39),
        (52, 28, 46, 39),
        (53, 28, 46, 39),
        (53, 28, 46, 39),
        (54, 28, 46, 39),
        (53, 29, 46, 39),
        (53, 29, 46, 39),
        (55, 30, 46, 39),
        (53, 32, 46, 39),
        (54, 35, 46, 37),
        (55, 36, 46, 37),
        (54, 37, 46, 37),
        (55, 38, 46, 37),
        (54, 40, 46, 37),
        (53, 40, 46, 37),
        (53, 42, 46, 37),
        (52, 41, 46, 37),
        (52, 45, 46, 37),
        (52, 43, 46, 37),
        (52, 46, 46, 37),
        (52, 45, 46, 40),
        (53, 46, 46, 40),
        (53, 49, 46, 40),
        (53, 50, 46, 40),
        (53, 50, 46, 40),
        (53, 54, 46, 40),
        (53, 52, 46, 40),
        (52, 50, 46, 40),
        (53, 47, 46, 40),
        (53, 48, 46, 40),
        (52, 46, 46, 40),
        (51, 49, 46, 40),
        (51, 48, 46, 40),
        (51, 50, 46, 40),
        (52, 52, 46, 40),
        (50, 52, 46, 40),
        (52, 49, 46, 40),
        (52, 51, 46, 40),
        (51, 51, 46, 40),
        (52, 52, 46, 40),
        (53, 51, 46, 40),
        (50, 51, 46, 40),
        (52, 51, 51, 40),
        (52, 51, 46, 40),
        (54, 52, 46, 40),
        (52, 51, 46, 40),
        (54, 51, 46, 40),
        (54, 51, 46, 40),
        (52, 52, 46, 40),
        (52, 52, 46, 40),
        (52, 53, 46, 40),
        (52, 55, 43, 40),
        (50, 54, 43, 40),
        (51, 55, 43, 40),
        (49, 55, 43, 40),
        (52, 49, 43, 40),
        (50, 49, 47, 40),
        (48, 46, 47, 40),
        (50, 41, 51, 43),
        (51, 34, 51, 43),
        (52, 36, 51, 43),
        (54, 31, 51, 43),
        (54, 24, 53, 45),
        (55, 26, 53, 45),
        (57, 22, 53, 45),
        (57, 22, 46, 39),
        (58, 20, 46, 39),
        (59, 17, 46, 39),
        (59, 19, 46, 39),
        (61, 21, 46, 39),
        (61, 21, 46, 39),
        (61, 22, 46, 39),
        (57, 19, 46, 39),
        (48, 19, 46, 39),
        (45, 25, 46, 39),
        (44, 23, 46, 39)
    ]
    
    total_frames = 84  # 一共84帧
    
    for i in range(total_frames):
        # 1. 加载模板作为底层
        frame = BuildImage.open(img_dir / f"{i}.png")
        
        # 2. 检查是否有对应的位置数据
        if i < len(locs):
            # 有位置数据，贴上头像
            x, y, width, height = locs[i]
            avatar_resized = avatar.resize((width, height))
            frame.paste(avatar_resized, (x, y), alpha=True)
        
        frames.append(frame.image)
    
    return save_gif(frames, 0.05)

add_meme(
    "tuhalang",
    tuhalang,
    min_images=1,
    max_images=1,
    keywords=["兔哈郎"],
    date_created=datetime(2025, 12, 25),
    date_modified=datetime(2025, 12, 25),
)